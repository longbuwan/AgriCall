<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤ - AgriCall Burn Verification</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="dashboard.css">
  <style>
    .verification-container {
      min-height: 100vh;
      background: var(--light-cream);
      padding-bottom: 80px;
    }

    .verification-header {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      color: var(--white);
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .header-subtitle {
      font-size: 0.9375rem;
      opacity: 0.95;
      line-height: 1.5;
    }

    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Mode Selection */
    .mode-selector {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .mode-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-dark);
    }

    .mode-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .mode-btn {
      padding: 1.25rem;
      border: 2px solid var(--border-light);
      background: var(--white);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .mode-btn:hover {
      border-color: var(--primary-green);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .mode-btn.active {
      border-color: var(--primary-green);
      background: linear-gradient(135deg, rgba(127, 173, 107, 0.1) 0%, rgba(107, 155, 90, 0.1) 100%);
      box-shadow: var(--shadow-md);
    }

    .mode-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .mode-name {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.25rem;
    }

    .mode-description {
      font-size: 0.875rem;
      color: var(--text-medium);
      line-height: 1.4;
    }

    /* Map Section */
    .map-section {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .map-controls {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .map-controls .btn {
      flex: 1;
      min-width: 150px;
    }

    #verificationMap {
      height: 500px;
      border-radius: var(--radius-lg);
      border: 2px solid var(--border-light);
      margin-bottom: 1rem;
    }

    .map-info {
      background: rgba(127, 173, 107, 0.1);
      padding: 1rem;
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--primary-green);
    }

    .map-info-title {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .map-info-text {
      font-size: 0.875rem;
      color: var(--text-medium);
      line-height: 1.5;
    }

    /* Field Info */
    .field-info {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
      display: none;
    }

    .field-info.show {
      display: block;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-light);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 500;
      color: var(--text-medium);
    }

    .info-value {
      font-weight: 600;
      color: var(--text-dark);
      text-align: right;
    }

    /* Results Section */
    .results-section {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
      display: none;
    }

    .results-section.show {
      display: block;
    }

    .result-card {
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .result-card.success {
      background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
      color: var(--white);
    }

    .result-card.warning {
      background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%);
      color: var(--white);
    }

    .result-icon {
      font-size: 4rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .result-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .result-subtitle {
      text-align: center;
      font-size: 1rem;
      opacity: 0.95;
      margin-bottom: 1rem;
    }

    .result-stats {
      background: rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-top: 1rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      font-size: 0.9375rem;
    }

    .confidence-section {
      background: var(--white);
      color: var(--text-dark);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-top: 1rem;
    }

    .confidence-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .confidence-bar {
      height: 8px;
      background: var(--border-light);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      transition: width 0.5s ease;
    }

    .confidence-text {
      font-size: 0.875rem;
      color: var(--text-medium);
      line-height: 1.5;
    }

    .reward-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: var(--white);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      margin-top: 1rem;
    }

    .reward-amount {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .action-buttons .btn {
      flex: 1;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      .mode-buttons {
        grid-template-columns: 1fr;
      }

      #verificationMap {
        height: 400px;
      }

      .map-controls {
        flex-direction: column;
      }

      .map-controls .btn {
        width: 100%;
      }

      .reward-amount {
        font-size: 2rem;
      }
    }

    /* Loading Animation */
    .analyzing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .analyzing-overlay.show {
      display: flex;
    }

    .analyzing-content {
      text-align: center;
      padding: 2rem;
    }

    .analyzing-spinner {
      width: 80px;
      height: 80px;
      border: 6px solid var(--border-light);
      border-top-color: var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    .analyzing-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .analyzing-subtext {
      font-size: 0.9375rem;
      color: var(--text-medium);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="verification-container">
    <!-- Header -->
    <div class="verification-header">
      <div class="header-content">
        <div class="header-title">
          <span>üî•</span>
          <span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡πÑ‡∏£‡πà‡∏ô‡∏≤</span>
        </div>
        <div class="header-subtitle">
          ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏£‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤<br>
          ‡∏£‡∏±‡∏ö 100 AgriCoins ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö!<br>
          Verify your farm has no burning in the last 3 months and earn 100 AgriCoins!
        </div>
      </div>
    </div>

    <div class="content-wrapper">
      <!-- Mode Selection -->
      <div class="mode-selector">
        <div class="mode-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏õ‡∏•‡∏á / Select Field Method</div>
        <div class="mode-buttons">
          <div class="mode-btn active" data-mode="auto" onclick="selectMode('auto')">
            <div class="mode-icon">ü§ñ</div>
            <div class="mode-name">‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            <div class="mode-description">
              Auto-Detect<br>
              ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            </div>
          </div>
          <div class="mode-btn" data-mode="manual" onclick="selectMode('manual')">
            <div class="mode-icon">‚úèÔ∏è</div>
            <div class="mode-name">‡∏ß‡∏≤‡∏î‡πÄ‡∏≠‡∏á</div>
            <div class="mode-description">
              Manual Draw<br>
              ‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
            </div>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="map-section">
        <div class="map-controls">
          <button class="btn btn-primary" onclick="useCurrentLocation()">
            üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          </button>
          <button class="btn btn-secondary" id="drawPolygonBtn" onclick="enableDrawing()" style="display: none;">
            ‚úèÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
          </button>
          <button class="btn btn-secondary" id="clearPolygonBtn" onclick="clearPolygon()">
            üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
          </button>
        </div>

        <div id="verificationMap"></div>

        <div class="map-info" id="mapInstructions">
          <div class="map-info-title">
            <span>üí°</span>
            <span>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
          </div>
          <div class="map-info-text" id="instructionText">
            <strong>‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:</strong><br>
            1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà<br>
            2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
            3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤"
          </div>
        </div>
      </div>

      <!-- Field Info -->
      <div class="field-info" id="fieldInfo">
        <h3 style="margin-bottom: 1rem;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á / Field Information</h3>
        <div class="info-row">
          <div class="info-label">üìè ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
          <div class="info-value" id="fieldArea">- ‡πÑ‡∏£‡πà</div>
        </div>
        <div class="info-row">
          <div class="info-label">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
          <div class="info-value">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (90 ‡∏ß‡∏±‡∏ô)</div>
        </div>
        <div class="info-row">
          <div class="info-label">üõ∞Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</div>
          <div class="info-value">NASA MODIS (500m)</div>
        </div>

        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="analyzeBurnScar()">
          üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤
        </button>
      </div>

      <!-- Results Section -->
      <div class="results-section" id="resultsSection">
        <div class="result-card" id="resultCard">
          <div class="result-icon" id="resultIcon">‚úÖ</div>
          <div class="result-title" id="resultTitle">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö!</div>
          <div class="result-subtitle" id="resultSubtitle">
            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
          </div>

          <div class="result-stats">
            <div class="stat-row">
              <span>‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
              <span id="resultArea">-</span>
            </div>
            <div class="stat-row">
              <span>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏≤:</span>
              <span id="resultBurnedArea">0 ‡πÑ‡∏£‡πà</span>
            </div>
            <div class="stat-row">
              <span>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤:</span>
              <span id="resultBurnPercentage">0%</span>
            </div>
            <div class="stat-row">
              <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span>
              <span id="resultDate">-</span>
            </div>
          </div>

          <div class="confidence-section">
            <div class="confidence-title">
              <span>üìä</span>
              <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
            </div>
            <div class="confidence-bar">
              <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
            </div>
            <div class="confidence-text" id="confidenceReason">-</div>
          </div>

          <div class="reward-banner" id="rewardBanner" style="display: none;">
            <div>üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</div>
            <div class="reward-amount">
              <img src="Untitled_design-removebg-preview.png" class="coin" style="width: 40px; height: 40px;">
              <span>+100</span>
            </div>
            <div>AgriCoins ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß!</div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="resetVerification()">
            üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
          </button>
          <button class="btn btn-primary" onclick="viewHistory()">
            üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
          </button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="mobile-nav">
      <a href="home.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">üè†</div>
        <div class="mobile-nav-label">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
      </a>
      <a href="burn-verification.html" class="mobile-nav-item active">
        <div class="mobile-nav-icon">üî•</div>
        <div class="mobile-nav-label">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
      </a>
      <a href="market.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">üõí</div>
        <div class="mobile-nav-label">‡∏ï‡∏•‡∏≤‡∏î</div>
      </a>
      <a href="#" class="mobile-nav-item" onclick="logout()">
        <div class="mobile-nav-icon">üö™</div>
        <div class="mobile-nav-label">‡∏≠‡∏≠‡∏Å</div>
      </a>
    </nav>
  </div>

  <!-- Analyzing Overlay -->
  <div class="analyzing-overlay" id="analyzingOverlay">
    <div class="analyzing-content">
      <div class="analyzing-spinner"></div>
      <div class="analyzing-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°...</div>
      <div class="analyzing-subtext">
        Analyzing satellite data from NASA MODIS<br>
        This may take 10-30 seconds
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast" style="display: none;"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="utils.js"></script>
  <script src="api.js"></script>
<script>
    // Check authentication
    const currentUser = Auth.getCurrentUser();
    if (!currentUser) {
      window.location.href = 'index.html';
    }

    // Global variables
    let verificationMap = null;
    let currentMode = 'auto';
    let selectedPolygon = null;
    let currentMarker = null;
    let drawnItems = null;
    let drawControl = null;
    let baseLayers = {};
    let currentBaseLayer = null;

    // Initialize map with realistic satellite imagery
    function initMap() {
      // Create map centered on Thailand
      verificationMap = L.map('verificationMap').setView([18.7883, 98.9853], 13);

      // ========================================
      // SATELLITE IMAGERY LAYERS
      // ========================================

      // Esri World Imagery (High-quality satellite)
      const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxZoom: 19,
        minZoom: 1
      });

      // Google Satellite (Alternative - requires no API key for tiles)
      const googleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: 'Map data &copy; Google',
        maxZoom: 20,
        minZoom: 1
      });

      // Google Hybrid (Satellite + Labels)
      const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        attribution: 'Map data &copy; Google',
        maxZoom: 20,
        minZoom: 1
      });

      // OpenStreetMap (Backup)
      const osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      });

      // Add default layer (Google Hybrid - best for farmland)
      googleHybrid.addTo(verificationMap);
      currentBaseLayer = googleHybrid;

      // Store layers for switching
      baseLayers = {
        "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° + ‡∏õ‡πâ‡∏≤‡∏¢ (Google Hybrid)": googleHybrid,
        "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Google Satellite)": googleSatellite,
        "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": esriSatellite,
        "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô (OpenStreetMap)": osmMap
      };

      // Add layer control
      L.control.layers(baseLayers, null, {
        position: 'topright',
        collapsed: true
      }).addTo(verificationMap);

      // Add scale control
      L.control.scale({
        metric: true,
        imperial: false,
        position: 'bottomleft'
      }).addTo(verificationMap);

      // Initialize drawing layer
      drawnItems = new L.FeatureGroup();
      verificationMap.addLayer(drawnItems);

      // Click handler for auto mode
      verificationMap.on('click', async function(e) {
        if (currentMode === 'auto') {
          await handleAutoDetect(e.latlng.lat, e.latlng.lng);
        }
      });

      // Add custom zoom control with better styling
      verificationMap.zoomControl.setPosition('topright');
    }

    // Select mode
    function selectMode(mode) {
      currentMode = mode;
      
      // Update button states
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

      // Clear existing polygon
      clearPolygon();

      // Update instructions and controls
      if (mode === 'auto') {
        document.getElementById('drawPolygonBtn').style.display = 'none';
        document.getElementById('instructionText').innerHTML = `
          <strong>‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:</strong><br>
          1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°<br>
          2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ESA WorldCover<br>
          3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤"
        `;
      } else {
        document.getElementById('drawPolygonBtn').style.display = 'block';
        document.getElementById('instructionText').innerHTML = `
          <strong>‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î‡πÄ‡∏≠‡∏á:</strong><br>
          1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"<br>
          2. ‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á<br>
          3. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á<br>
          4. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤"
        `;
      }
    }

    // Use current location
    async function useCurrentLocation() {
      try {
        Loading.show();
        Toast.show('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...', 'info');

        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // Move map to location with higher zoom for satellite view
        verificationMap.setView([lat, lng], 17);

        if (currentMode === 'auto') {
          await handleAutoDetect(lat, lng);
        } else {
          // Just add marker for manual mode
          if (currentMarker) {
            verificationMap.removeLayer(currentMarker);
          }
          
          // Custom icon for current location
          currentMarker = L.marker([lat, lng], {
            icon: L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            })
          }).addTo(verificationMap)
            .bindPopup('üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>Your current location')
            .openPopup();
          
          Toast.success('‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á');
        }

        Loading.hide();
      } catch (error) {
        Loading.hide();
        
        let errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
        if (error.code === 1) {
          errorMsg = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
        } else if (error.code === 2) {
          errorMsg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS';
        } else if (error.code === 3) {
          errorMsg = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
        }
        
        Toast.error(errorMsg);
        console.error('Location error:', error);
      }
    }

    // Handle auto-detect
    async function handleAutoDetect(lat, lng) {
      try {
        Loading.show();
        Toast.show('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°...', 'info');

        // Clear previous
        clearPolygon();

        // Add marker with custom icon
        if (currentMarker) {
          verificationMap.removeLayer(currentMarker);
        }
        currentMarker = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          })
        }).addTo(verificationMap)
          .bindPopup('üåæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏õ‡∏•‡∏á...<br>Analyzing farmland...')
          .openPopup();

        // Call backend to detect farmland (auto mode will return polygon)
        const result = await API.callBackend('/api/burn-scar/analyze', {
          mode: 'auto',
          lat: lat,
          lng: lng,
          radius_m: 500,
          days_back: 1, // Just to get polygon, actual analysis later
          user_id: currentUser.id
        });

        Loading.hide();

        if (result.success && result.polygon) {
          selectedPolygon = result.polygon;
          
          // Draw polygon on map with highlighted style
          const layer = L.geoJSON(selectedPolygon, {
            style: {
              color: '#4CAF50',
              weight: 3,
              opacity: 0.8,
              fillColor: '#7FAD6B',
              fillOpacity: 0.3,
              dashArray: '5, 5'
            }
          }).addTo(drawnItems);

          // Update marker popup
          currentMarker.setPopupContent('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£<br>Farmland detected');

          // Fit bounds to show entire polygon
          const bounds = layer.getBounds();
          verificationMap.fitBounds(bounds, { padding: [50, 50] });

          // Show field info
          const areaHa = result.farm_area_ha;
          const areaRai = (areaHa * 0.625).toFixed(2); // Convert to rai
          document.getElementById('fieldArea').textContent = `${areaRai} ‡πÑ‡∏£‡πà (${areaHa.toFixed(2)} hectares)`;
          document.getElementById('fieldInfo').classList.add('show');

          Toast.success('‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°');
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏î‡πÄ‡∏≠‡∏á');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á');
        console.error('Auto-detect error:', error);
      }
    }

    // Enable manual drawing with enhanced visual feedback
    function enableDrawing() {
      if (drawControl) {
        verificationMap.removeControl(drawControl);
      }

      drawControl = new L.Control.Draw({
        draw: {
          polygon: {
            allowIntersection: false,
            showArea: true,
            metric: true,
            shapeOptions: {
              color: '#4CAF50',
              weight: 3,
              opacity: 0.8,
              fillColor: '#7FAD6B',
              fillOpacity: 0.3
            }
          },
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: drawnItems,
          remove: true
        }
      });

      verificationMap.addControl(drawControl);

      // Handle draw created
      verificationMap.on(L.Draw.Event.CREATED, function(e) {
        const layer = e.layer;
        
        // Clear previous drawings
        drawnItems.clearLayers();
        
        // Add new layer
        drawnItems.addLayer(layer);

        // Get polygon coordinates
        const latlngs = layer.getLatLngs()[0];
        const coordinates = latlngs.map(ll => [ll.lng, ll.lat]);
        coordinates.push(coordinates[0]); // Close polygon

        selectedPolygon = {
          type: 'Polygon',
          coordinates: [coordinates]
        };

        // Calculate area using Leaflet's geodesic calculation
        const area = L.GeometryUtil.geodesicArea(latlngs);
        const areaHa = (area / 10000).toFixed(2);
        const areaRai = (areaHa * 0.625).toFixed(2);

        document.getElementById('fieldArea').textContent = `${areaRai} ‡πÑ‡∏£‡πà (${areaHa} hectares)`;
        document.getElementById('fieldInfo').classList.add('show');

        // Add popup to polygon
        layer.bindPopup(`
          <strong>üåæ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</strong><br>
          ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${areaRai} ‡πÑ‡∏£‡πà<br>
          (${areaHa} hectares)
        `).openPopup();

        Toast.success('‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      });

      Toast.info('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á');
    }

    // Clear polygon
    function clearPolygon() {
      drawnItems.clearLayers();
      selectedPolygon = null;
      document.getElementById('fieldInfo').classList.remove('show');
      document.getElementById('resultsSection').classList.remove('show');
      
      if (currentMarker) {
        verificationMap.removeLayer(currentMarker);
        currentMarker = null;
      }
      
      if (drawControl) {
        verificationMap.removeControl(drawControl);
        drawControl = null;
      }
    }

    // Analyze burn scar
    async function analyzeBurnScar() {
      if (!selectedPolygon) {
        Toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      try {
        // Show analyzing overlay
        document.getElementById('analyzingOverlay').classList.add('show');

        // Prepare request
        const requestData = {
          user_id: currentUser.id,
          days_back: 90, // 3 months
          mode: 'custom',
          polygon: selectedPolygon
        };

        // Call backend
        const result = await API.callBackend('/api/burn-scar/analyze', requestData);

        // Hide analyzing overlay
        document.getElementById('analyzingOverlay').classList.remove('show');

        if (result.success) {
          await displayResults(result);
        } else {
          Toast.error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
        }
      } catch (error) {
        document.getElementById('analyzingOverlay').classList.remove('show');
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
        console.error('Analysis error:', error);
      }
    }

    // Display results
    async function displayResults(result) {
      const resultCard = document.getElementById('resultCard');
      const areaHa = result.farm_area_ha;
      const areaRai = (areaHa * 0.625).toFixed(2);
      const burnedRai = (result.burned_area_ha * 0.625).toFixed(2);

      // Update area
      document.getElementById('resultArea').textContent = `${areaRai} ‡πÑ‡∏£‡πà`;
      document.getElementById('resultBurnedArea').textContent = `${burnedRai} ‡πÑ‡∏£‡πà`;
      document.getElementById('resultBurnPercentage').textContent = `${result.burn_percentage}%`;
      document.getElementById('resultDate').textContent = new Date().toLocaleDateString('th-TH');

      // Update confidence
      const confidencePercent = (result.confidence_score * 100).toFixed(0);
      document.getElementById('confidenceFill').style.width = `${confidencePercent}%`;
      document.getElementById('confidenceReason').textContent = result.confidence_reason;

      if (!result.burn_detected) {
        // SUCCESS - No burning detected
        resultCard.className = 'result-card success';
        document.getElementById('resultIcon').textContent = '‚úÖ';
        document.getElementById('resultTitle').textContent = '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö!';
        document.getElementById('resultSubtitle').textContent = 
          '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ / No burning detected in the last 3 months';

        // Show reward banner
        document.getElementById('rewardBanner').style.display = 'block';

        // Award AgriCoins
        try {
          const rewardResult = await API.callBackend('/agricoin/add', {
            user_id: currentUser.id,
            amount: 100,
            description: 'Burn-free verification reward (3 months)'
          });

          if (rewardResult.success) {
            Toast.success('üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 100 AgriCoins ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß!', 3000);
            
            // Update user balance in localStorage
            currentUser.agricoin_balance = rewardResult.transaction.new_balance;
            Auth.setCurrentUser(currentUser);
          }
        } catch (error) {
          console.error('Reward error:', error);
        }

        // Add green overlay to polygon on map
        drawnItems.eachLayer(function(layer) {
          layer.setStyle({
            color: '#4CAF50',
            fillColor: '#66BB6A',
            fillOpacity: 0.4
          });
          layer.bindPopup('‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br>No burning detected').openPopup();
        });

      } else {
        // WARNING - Burning detected
        resultCard.className = 'result-card warning';
        document.getElementById('resultIcon').textContent = '‚ö†Ô∏è';
        document.getElementById('resultTitle').textContent = '‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤!';
        document.getElementById('resultSubtitle').textContent = 
          `‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤ ${result.burn_percentage}% ‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà / Burning detected on ${result.burn_percentage}% of area`;

        // Hide reward banner
        document.getElementById('rewardBanner').style.display = 'none';

        Toast.warning('‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡πÉ‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤', 3000);

        // Add red overlay to polygon on map
        drawnItems.eachLayer(function(layer) {
          layer.setStyle({
            color: '#EF5350',
            fillColor: '#E57373',
            fillOpacity: 0.4
          });
          layer.bindPopup(`‚ö†Ô∏è ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤ ${result.burn_percentage}%<br>Burning detected`).openPopup();
        });
      }

      // Show results
      document.getElementById('resultsSection').classList.add('show');
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Reset verification
    function resetVerification() {
      clearPolygon();
      document.getElementById('resultsSection').classList.remove('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      Toast.info('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà');
    }

    // View history
    function viewHistory() {
      // Navigate to home and show stats
      window.location.href = 'home.html';
    }

    // Logout
    function logout() {
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        Auth.logout();
        window.location.href = 'index.html';
      }
    }

    // Initialize on load
    window.addEventListener('load', function() {
      initMap();
      Toast.success('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°!');
    });
  </script>
</body>
</html>
