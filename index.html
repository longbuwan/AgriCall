<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AgriCall - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Mobile-Optimized Login Styles */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: var(--light-cream);
    }
    
    .login-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 2rem 1.5rem;
      max-width: 450px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }
    
    /* Decorative background */
    .login-card::before {
      content: '';
      position: absolute;
      top: -80px;
      right: -80px;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(165, 201, 149, 0.15) 0%, transparent 70%);
      pointer-events: none;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
      z-index: 1;
    }
    
    .logo {
      font-size: 3.5rem;
      margin-bottom: 0.75rem;
      animation: bounce 2s ease infinite;
    }
    
    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-8px);
      }
    }
    
    .app-title {
      font-family: 'Itim', 'Sriracha', cursive;
      font-size: 2rem;
      color: var(--primary-green);
      margin-bottom: 0.5rem;
      line-height: 1.2;
    }
    
    .app-subtitle {
      color: var(--text-medium);
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 0 1rem;
    }
    
    /* User Type Selector */
    .user-type-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.625rem;
      margin-bottom: 1.5rem;
    }
    
    .user-type-option {
      position: relative;
    }
    
    .user-type-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .user-type-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.875rem 0.5rem;
      border: 2px solid var(--border-light);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      background: var(--white);
      min-height: 100px;
      height: 100%;
    }
    
    .user-type-icon {
      font-size: 2.25rem;
      margin-bottom: 0.375rem;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }
    
    .user-type-text {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-medium);
      line-height: 1.3;
      transition: color 0.3s ease;
      word-break: keep-all;
      hyphens: none;
    }
    
    .user-type-option input[type="radio"]:checked + .user-type-label {
      border-color: var(--primary-green);
      background: rgba(127, 173, 107, 0.05);
    }
    
    .user-type-option input[type="radio"]:checked + .user-type-label .user-type-icon {
      filter: grayscale(0%);
    }
    
    .user-type-option input[type="radio"]:checked + .user-type-label .user-type-text {
      color: var(--primary-green);
      font-weight: 600;
    }
    
    .user-type-label:active {
      transform: scale(0.97);
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-dark);
      font-size: 0.9375rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--border-light);
      border-radius: var(--radius-md);
      font-family: 'Prompt', sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: var(--white);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(127, 173, 107, 0.1);
    }
    
    /* Phone Input with Country Code */
    .phone-input-group {
      display: flex;
      gap: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }
    
    .phone-input-group input.country-code {
      width: 70px !important;
      min-width: 70px !important;
      max-width: 70px !important;
      flex: 0 0 70px !important;
      text-align: center;
      background: var(--light-cream);
      font-weight: 600;
      color: var(--text-dark);
      padding: 0.875rem 0.25rem;
      font-size: 0.875rem;
    }
    
    .phone-input-group input.phone-input {
      flex: 1 1 auto !important;
      width: auto !important;
      min-width: 0 !important;
    }
    
    /* OTP Input Group */
    .otp-input-group {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      margin: 1.5rem 0;
    }
    
    .otp-input {
      width: 55px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      border: 2px solid var(--border-light);
      border-radius: var(--radius-md);
      transition: all 0.3s ease;
    }
    
    .otp-input:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(127, 173, 107, 0.15);
    }
    
    .otp-input.filled {
      border-color: var(--primary-green);
      background: rgba(127, 173, 107, 0.05);
    }
    
    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
      color: var(--white);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Prompt', sans-serif;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(127, 173, 107, 0.3);
      margin-top: 0.5rem;
    }
    
    .submit-btn:active {
      transform: scale(0.98);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Secondary Button */
    .secondary-btn {
      width: 100%;
      padding: 0.875rem;
      background: var(--white);
      color: var(--primary-green);
      border: 2px solid var(--primary-green);
      border-radius: var(--radius-md);
      font-family: 'Prompt', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 0.75rem;
    }
    
    .secondary-btn:active {
      transform: scale(0.98);
    }
    
    /* Register Link */
    .register-link {
      text-align: center;
      margin-top: 1.5rem;
      color: var(--text-medium);
      font-size: 0.9375rem;
    }
    
    .register-link a {
      color: var(--primary-green);
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    
    .register-link a:active {
      opacity: 0.7;
    }
    
    /* Demo Credentials */
    .demo-credentials {
      background: rgba(165, 201, 149, 0.08);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-top: 1.5rem;
      font-size: 0.8125rem;
      border: 1px solid rgba(127, 173, 107, 0.2);
    }
    
    .demo-credentials h4 {
      color: var(--primary-green);
      margin-bottom: 0.625rem;
      font-size: 0.9375rem;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    
    .demo-credentials p {
      margin: 0.375rem 0;
      color: var(--text-medium);
      line-height: 1.4;
    }
    
    .demo-credentials strong {
      color: var(--text-dark);
    }
    
    /* Step Indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border-light);
      transition: all 0.3s ease;
    }
    
    .step-dot.active {
      background: var(--primary-green);
      width: 30px;
      border-radius: 5px;
    }
    
    .step-dot.completed {
      background: var(--primary-green);
    }
    
    /* OTP Info Box */
    .otp-info {
      background: rgba(91, 138, 200, 0.1);
      border: 1px solid rgba(91, 138, 200, 0.2);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .otp-info-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .otp-info-text {
      font-size: 0.875rem;
      color: var(--text-medium);
      line-height: 1.5;
    }
    
    .otp-info-phone {
      font-weight: 700;
      color: var(--text-dark);
      font-size: 1.125rem;
      margin-top: 0.25rem;
    }
    
    /* Resend OTP */
    .resend-otp {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.875rem;
      color: var(--text-medium);
    }
    
    .resend-otp a {
      color: var(--primary-green);
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    
    .resend-otp a.disabled {
      color: var(--text-light);
      cursor: not-allowed;
    }
    
    /* SMS Animation */
    .sms-animation {
      display: none;
      text-align: center;
      padding: 2rem;
    }
    
    .sms-animation.active {
      display: block;
    }
    
    .sms-icon {
      font-size: 4rem;
      animation: smsFloat 1.5s ease-in-out infinite;
    }
    
    @keyframes smsFloat {
      0%, 100% {
        transform: translateY(0) rotate(-5deg);
      }
      50% {
        transform: translateY(-15px) rotate(5deg);
      }
    }
    
    .sms-text {
      margin-top: 1rem;
      color: var(--text-medium);
      font-size: 0.9375rem;
    }
    
    /* Hidden forms */
    .form-step {
      display: none;
    }
    
    .form-step.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Modal Adjustments for Mobile */
    .modal-content {
      max-height: 85vh;
      padding: 1.5rem;
    }
    
    .modal-content h2 {
      font-size: 1.5rem;
      margin-bottom: 0;
    }
    
    .modal-content .form-group {
      margin-bottom: 1rem;
    }
    
    .modal-content textarea {
      min-height: 80px;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 480px) {
      .login-card {
        padding: 1.5rem 1rem;
      }
      
      .logo {
        font-size: 3rem;
      }
      
      .app-title {
        font-size: 1.75rem;
      }
      
      .app-subtitle {
        font-size: 0.875rem;
        padding: 0 0.5rem;
      }
      
      .user-type-selector {
        gap: 0.5rem;
      }
      
      .user-type-label {
        padding: 0.75rem 0.375rem;
        min-height: 95px;
      }
      
      .user-type-icon {
        font-size: 2rem;
      }
      
      .user-type-text {
        font-size: 0.75rem;
      }
      
      .demo-credentials {
        font-size: 0.75rem;
        padding: 0.875rem;
      }
      
      .demo-credentials h4 {
        font-size: 0.875rem;
      }
      
      .otp-input {
        width: 48px;
        height: 55px;
        font-size: 1.25rem;
      }
      
      .phone-input-group input.country-code {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
        flex: 0 0 60px !important;
        font-size: 0.75rem;
        padding: 0.875rem 0.125rem;
      }
    }
    
    /* Landscape Mobile */
    @media (max-height: 600px) and (orientation: landscape) {
      .login-container {
        padding: 1rem;
      }
      
      .login-card {
        padding: 1rem;
      }
      
      .logo {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }
      
      .login-header {
        margin-bottom: 1rem;
      }
      
      .form-group {
        margin-bottom: 0.875rem;
      }
      
      .demo-credentials {
        margin-top: 1rem;
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="logo">üåæ</div>
        <h1 class="app-title">AgriCall</h1>
        <p class="app-subtitle">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ ‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤<br>‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤ ‡∏•‡∏î PM 2.5</p>
      </div>
      
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step-dot active" id="step1Dot"></div>
        <div class="step-dot" id="step2Dot"></div>
      </div>
      
      <!-- Step 1: Phone Number -->
      <div class="form-step active" id="step1">
        <form id="phoneForm">
          <div class="form-group">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ / User Type</label>
            <div class="user-type-selector">
              <div class="user-type-option">
                <input type="radio" name="userType" id="typeCustomer" value="customer" checked>
                <label for="typeCustomer" class="user-type-label">
                  <span class="user-type-icon">üë®‚Äçüíº</span>
                  <span class="user-type-text">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤<br>Customer</span>
                </label>
              </div>
              
              <div class="user-type-option">
                <input type="radio" name="userType" id="typeFarmer" value="farmer">
                <label for="typeFarmer" class="user-type-label">
                  <span class="user-type-icon">üë®‚Äçüåæ</span>
                  <span class="user-type-text">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£<br>Farmer</span>
                </label>
              </div>
              
              <div class="user-type-option">
                <input type="radio" name="userType" id="typeBaler" value="baler">
                <label for="typeBaler" class="user-type-label">
                  <span class="user-type-icon">üöú</span>
                  <span class="user-type-text">‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á<br>Baler</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå / Phone Number</label>
            <div class="phone-input-group">
              <input type="text" class="country-code" value="+66" readonly>
              <input type="tel" id="phone" name="phone" class="phone-input" 
                     placeholder="812345678" required 
                     pattern="[0-9]{9,10}" 
                     maxlength="10"
                     autocomplete="tel">
            </div>
          </div>
          
          <button type="submit" class="submit-btn">
            üì± ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP / Get OTP
          </button>
        </form>
        
        <div class="demo-credentials">
          <h4>üì± Demo Phone Numbers</h4>
          <p><strong>Customer:</strong> 0812345678</p>
          <p><strong>Farmer:</strong> 0823456789</p>
          <p><strong>Baler:</strong> 0834567890</p>
          <p style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed rgba(127, 173, 107, 0.3);">
            <strong>üîë OTP Code:</strong> 1234 (‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå)
          </p>
        </div>
      </div>
      
      <!-- SMS Sending Animation -->
      <div class="sms-animation" id="smsAnimation">
        <div class="sms-icon">üì®</div>
        <p class="sms-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á SMS...<br>Sending SMS...</p>
      </div>
      
      <!-- Step 2: OTP Verification -->
      <div class="form-step" id="step2">
        <div class="otp-info">
          <div class="otp-info-icon">üì±</div>
          <p class="otp-info-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP 4 ‡∏´‡∏•‡∏±‡∏Å<br>‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå</p>
          <p class="otp-info-phone" id="displayPhone">081-234-5678</p>
        </div>
        
        <form id="otpForm">
          <div class="otp-input-group">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
          </div>
          
          <button type="submit" class="submit-btn" id="verifyBtn">
            ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP / Verify
          </button>
          
          <button type="button" class="secondary-btn" id="backBtn">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö / Back
          </button>
        </form>
        
        <div class="resend-otp">
          <span id="resendText">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö OTP? </span>
          <a id="resendLink" onclick="resendOTP()">‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</a>
          <span id="resendTimer"></span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast" style="display: none;"></div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>
   
  <script src="utils.js"></script>
  <script src="api.js"></script>
  <script>
    // State
    let currentPhone = '';
    let currentUserType = 'customer';
    let resendCountdown = 0;
    
    // Check if user is already logged in
    const currentUser = Auth.getCurrentUser();
    if (currentUser) {
      window.location.href = 'home.html';
    }
    
    // Format phone number for display
    function formatPhoneDisplay(phone) {
      // Remove leading 0 if present
      const cleaned = phone.replace(/^0/, '');
      // Format as XXX-XXX-XXXX
      if (cleaned.length === 9) {
        return `0${cleaned.slice(0, 2)}-${cleaned.slice(2, 5)}-${cleaned.slice(5)}`;
      }
      return `0${cleaned.slice(0, 2)}-${cleaned.slice(2, 5)}-${cleaned.slice(5, 9)}`;
    }
    
    // Normalize phone number for API
    function normalizePhone(phone) {
      // Remove any non-digit characters
      let cleaned = phone.replace(/\D/g, '');
      // Ensure it starts with 0
      if (!cleaned.startsWith('0')) {
        cleaned = '0' + cleaned;
      }
      return cleaned;
    }
    
    // Show step
    function showStep(step) {
      document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      
      // Update step indicators
      document.getElementById('step1Dot').classList.toggle('active', step === 1);
      document.getElementById('step1Dot').classList.toggle('completed', step > 1);
      document.getElementById('step2Dot').classList.toggle('active', step === 2);
    }
    
    // Show SMS animation
    function showSMSAnimation() {
      document.getElementById('step1').classList.remove('active');
      document.getElementById('smsAnimation').classList.add('active');
    }
    
    // Hide SMS animation
    function hideSMSAnimation() {
      document.getElementById('smsAnimation').classList.remove('active');
    }
    
    // Start resend countdown
    function startResendCountdown() {
      resendCountdown = 30;
      const resendLink = document.getElementById('resendLink');
      const resendTimer = document.getElementById('resendTimer');
      
      resendLink.classList.add('disabled');
      resendLink.style.display = 'none';
      
      const interval = setInterval(() => {
        resendCountdown--;
        resendTimer.textContent = ` (${resendCountdown}s)`;
        
        if (resendCountdown <= 0) {
          clearInterval(interval);
          resendLink.classList.remove('disabled');
          resendLink.style.display = 'inline';
          resendTimer.textContent = '';
        }
      }, 1000);
    }
    
    // Resend OTP
    function resendOTP() {
      if (resendCountdown > 0) return;
      
      Toast.info('üì® ‡∏™‡πà‡∏á OTP ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß / New OTP sent!');
      startResendCountdown();
    }
    
    // Phone form handler
    document.getElementById('phoneForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const phone = document.getElementById('phone').value;
      currentUserType = document.querySelector('input[name="userType"]:checked').value;
      
      // Validate phone
      if (!/^0?[0-9]{9,10}$/.test(phone.replace(/\D/g, ''))) {
        Toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á / Please enter a valid phone number');
        return;
      }
      
      currentPhone = normalizePhone(phone);
      
      // Show SMS animation
      showSMSAnimation();
      
      // Simulate SMS sending delay
      setTimeout(() => {
        hideSMSAnimation();
        showStep(2);
        
        // Update display phone
        document.getElementById('displayPhone').textContent = formatPhoneDisplay(currentPhone);
        
        // Focus first OTP input
        document.querySelector('.otp-input').focus();
        
        // Start resend countdown
        startResendCountdown();
        
        Toast.success('üì± ‡∏™‡πà‡∏á OTP ‡πÅ‡∏•‡πâ‡∏ß! / OTP sent!');
      }, 1500);
    });
    
    // OTP input handling
    const otpInputs = document.querySelectorAll('.otp-input');
    
    otpInputs.forEach((input, index) => {
      // Handle input
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // Only allow numbers
        e.target.value = value.replace(/\D/g, '');
        
        // Add filled class
        if (e.target.value) {
          e.target.classList.add('filled');
          
          // Auto-focus next input
          if (index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        } else {
          e.target.classList.remove('filled');
        }
        
        // Check if all filled - auto submit
        const allFilled = Array.from(otpInputs).every(i => i.value.length === 1);
        if (allFilled) {
          document.getElementById('otpForm').dispatchEvent(new Event('submit'));
        }
      });
      
      // Handle backspace
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          otpInputs[index - 1].focus();
        }
      });
      
      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
        
        pastedData.split('').forEach((char, i) => {
          if (otpInputs[i]) {
            otpInputs[i].value = char;
            otpInputs[i].classList.add('filled');
          }
        });
        
        // Focus last input or the one after pasted content
        const focusIndex = Math.min(pastedData.length, otpInputs.length - 1);
        otpInputs[focusIndex].focus();
      });
    });
    
    // OTP form handler
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get OTP value
      const otp = Array.from(otpInputs).map(i => i.value).join('');
      
      if (otp.length !== 4) {
        Toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OTP 4 ‡∏´‡∏•‡∏±‡∏Å / Please enter 4-digit OTP');
        return;
      }
      
      Loading.show();
      
      // Simulate OTP verification (always accept 1234)
      setTimeout(async () => {
        if (otp === '1234') {
          // OTP verified - login with phone
          try {
            const result = await API.loginWithPhone(currentPhone, currentUserType);
            
            Loading.hide();
            
            if (result.success) {
              Auth.setCurrentUser(result.user);
              Toast.success('üéâ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / Login successful!');
              
              // Redirect to home page
              setTimeout(() => {
                window.location.href = 'home.html';
              }, 1000);
            } else {
              Toast.error(result.error);
            }
          } catch (error) {
            Loading.hide();
            Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / An error occurred');
            console.error('Login error:', error);
          }
        } else {
          Loading.hide();
          Toast.error('‚ùå OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á / Invalid OTP');
          
          // Clear OTP inputs
          otpInputs.forEach(i => {
            i.value = '';
            i.classList.remove('filled');
          });
          otpInputs[0].focus();
        }
      }, 1000);
    });
    
    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      showStep(1);
      
      // Clear OTP inputs
      otpInputs.forEach(i => {
        i.value = '';
        i.classList.remove('filled');
      });
    });
  </script>
</body>
</html>
