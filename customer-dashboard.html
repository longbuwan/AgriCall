<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - AgriCall</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="dashboard.css">
  
  <!-- Leaflet CSS for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    /* Map container styles */
    .map-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border: 2px solid #e0e0e0;
    }
    
    .map-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .map-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .map-container {
      margin-bottom: 1rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    
    #deliveryMap {
      height: 450px;
      width: 100%;
      touch-action: pan-y;
    }
    
    .map-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .map-controls .btn {
      flex: 1;
      min-width: 160px;
      justify-content: center;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      touch-action: manipulation;
    }
    
    .location-info {
      background: #fff3cd;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border-left: 4px solid #ffc107;
    }
    
    .location-info.selected {
      background: #d4edda;
      border-left-color: #28a745;
    }
    
    .location-info h4 {
      margin: 0 0 0.5rem 0;
      color: #333;
      font-size: 0.95rem;
    }
    
    .location-info p {
      margin: 0.25rem 0;
      font-size: 0.9rem;
      color: #666;
    }
    
    .search-box {
      display: none;
      margin-bottom: 1rem;
      animation: slideDown 0.3s;
    }
    
    .search-box.show {
      display: block;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      #deliveryMap {
        height: 350px;
      }
      
      .map-controls .btn {
        font-size: 0.9rem;
        padding: 0.85rem;
        min-width: 100%;
      }
    }
    
    /* Leaflet marker customization */
    .leaflet-marker-icon {
      cursor: move !important;
    }
    
    .leaflet-dragging .leaflet-marker-icon {
      cursor: grabbing !important;
    }
    
    .address-preview {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: white;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
  </style>
</head>
<body class="dashboard">
  <!-- Header -->
  <header class="dashboard-header">
    <nav class="dashboard-nav">
      <a href="#" class="dashboard-logo">
        <span class="logo-icon">üåæ</span>
        <span>AgriCall</span>
      </a>
      
      <div class="dashboard-user">
        <div class="user-info">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-type">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Customer</div>
        </div>
        
        <button class="notification-bell" onclick="alert('Notifications feature coming soon!')">
          üîî
          <span class="notification-badge hidden" id="notifBadge">0</span>
        </button>
        
        <button class="logout-btn" onclick="Auth.logout()">
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö / Logout
        </button>
      </div>
    </nav>
  </header>
  
  <!-- Main Content -->
  <main class="dashboard-content">
    <div class="container">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card green">
          <div class="stat-label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / Total Orders</div>
          <div class="stat-value" id="totalOrders">0</div>
        </div>
        
        <div class="stat-card orange">
          <div class="stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ / Pending</div>
          <div class="stat-value" id="pendingOrders">0</div>
        </div>
        
        <div class="stat-card blue">
          <div class="stat-label">‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß / Delivered</div>
          <div class="stat-value" id="deliveredOrders">0</div>
        </div>
      </div>
      
      <!-- Create New Order Section -->
      <div class="card">
        <div class="section-header">
          <h2 class="section-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà / Create New Order</h2>
        </div>
        
        <form id="createOrderForm">
          <div class="d-flex gap-2" style="flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="baleType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á / Bale Type</label>
              <select id="baleType" name="bale_type" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á / Select Type</option>
                <option value="‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß (Rice Straw)">‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß / Rice Straw</option>
                <option value="‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏•‡∏µ (Wheat Straw)">‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏•‡∏µ / Wheat Straw</option>
              </select>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô / Quantity</label>
              <input type="number" id="quantity" name="quantity" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πâ‡∏≠‡∏ô / Number of bales" min="1" required>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="pickupDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö / Pickup Date</label>
              <input type="date" id="pickupDate" name="pickup_date" required>
            </div>
          </div>
          
          <!-- MAP SECTION - PRIMARY METHOD -->
          <div class="map-section">
            <div class="map-section-header">
              <div class="map-section-title">
                <span style="font-size: 1.3rem;">üìç</span>
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà / Select Delivery Location</span>
              </div>
            </div>
            
            <!-- Location Status Info -->
            <div id="locationInfo" class="location-info">
              <h4>üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô / How to use:</h4>
              <p>‚Ä¢ <strong>‡∏•‡∏≤‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ / <strong>Drag the red marker</strong> to your location</p>
              <p>‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î <strong>"üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ GPS / Or tap <strong>"Use GPS"</strong></p>
              <p>‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠<strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</strong> / Or <strong>search address</strong></p>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
              <button type="button" class="btn btn-primary" onclick="useGPSLocation()">
                üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô / Use GPS
              </button>
              <button type="button" class="btn btn-secondary" onclick="toggleAddressSearch()">
                üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / Search Address
              </button>
            </div>
            
            <!-- Search Box -->
            <div id="searchBox" class="search-box">
              <div style="display: flex; gap: 0.5rem;">
                <input 
                  type="text" 
                  id="addressSearchInput" 
                  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏ô‡∏ô‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏¥‡∏ô‡∏ó‡πå, ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"
                  style="flex: 1;"
                  onkeypress="if(event.key==='Enter'){event.preventDefault();searchAddress();}"
                >
                <button type="button" class="btn btn-primary" onclick="searchAddress()">
                  ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
              </div>
            </div>
            
            <!-- Interactive Map -->
            <div class="map-container">
              <div id="deliveryMap"></div>
            </div>
            
            <!-- Address Preview (replaces coordinates display) -->
            <div class="address-preview" id="addressPreview" style="display: none;">
              <strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å / Selected Location:</strong><br>
              <span id="addressPreviewText">-</span>
            </div>
          </div>
          
          <!-- Address Field (Auto-filled from map) -->
          <div class="form-group">
            <label for="deliveryAddress">
              ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á / Delivery Address
              <small style="color: #666; font-weight: normal;">(‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà / Auto-filled from map)</small>
            </label>
            <textarea 
              id="deliveryAddress" 
              name="delivery_address" 
              rows="2" 
              placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô / Please select location on map above"
              required
              readonly
              style="background-color: #f8f9fa; cursor: not-allowed;"
            ></textarea>
            
            <!-- Hidden fields for coordinates -->
            <input type="hidden" id="delivery_lat" name="delivery_lat" required>
            <input type="hidden" id="delivery_lng" name="delivery_lng" required>
          </div>
          
          <div class="form-group">
            <label for="notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / Notes (Optional)</label>
            <textarea id="notes" name="notes" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å, ‡∏Ç‡πâ‡∏≠‡∏Å‡πâ‡∏≠‡∏ô‡∏´‡∏ô‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©"></textarea>
          </div>
          
          <button type="submit" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
            ‚úì ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / Create Order
          </button>
        </form>
      </div>
      
      <!-- My Orders Section -->
      <div class="card">
        <div class="section-header">
          <h2 class="section-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / My Orders</h2>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á / Type</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô / Qty</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö / Date</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / Status</th>
                <th>‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ / Farmer</th>
                <th>‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á / Baler</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <tr>
                <td colspan="8" class="empty-state">
                  <div class="empty-state-icon">üì¶</div>
                  <div class="empty-state-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / No orders yet</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / Order Details</h2>
        <button type="button" class="close-modal" onclick="Modal.close('orderDetailsModal')">&times;</button>
      </div>
      
      <div id="orderDetailsContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Leaflet JS for maps -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script src="utils.js"></script>
  <script src="api.js"></script>
  
  <script>
    // Check authentication
    const currentUser = Auth.requireAuth(['customer']);
    if (!currentUser) {
      throw new Error('Not authenticated');
    }
    
    // Set user name
    document.getElementById('userName').textContent = currentUser.name;
    
    // ==================== MAP VARIABLES ====================
    let deliveryMap = null;
    let deliveryMarker = null;
    let selectedDeliveryLocation = null;
    
    // ==================== MAP INITIALIZATION ====================
    function initDeliveryMap() {
      const defaultCenter = [18.7883, 98.9853]; // Chiang Mai
      
      // Create map
      deliveryMap = L.map('deliveryMap', {
        center: defaultCenter,
        zoom: 13,
        zoomControl: true,
        touchZoom: true,
        dragging: true,
        tap: true
      });
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(deliveryMap);
      
      // Add draggable marker
      deliveryMarker = L.marker(defaultCenter, {
        draggable: true,
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(deliveryMap);
      
      // Bind popup to marker
      deliveryMarker.bindPopup('üñêÔ∏è ‡∏•‡∏≤‡∏Å‡∏â‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á!<br>Drag me to your delivery location!').openPopup();
      
      // Handle marker drag
      deliveryMarker.on('dragend', async function(e) {
        const position = e.target.getLatLng();
        await updateLocationFromMarker([position.lat, position.lng]);
      });
      
      // Handle map click (move marker)
      deliveryMap.on('click', async function(e) {
        const position = [e.latlng.lat, e.latlng.lng];
        deliveryMarker.setLatLng(position);
        await updateLocationFromMarker(position);
      });
      
      // Try to get user's location on initial load
      tryAutoGPS();
    }
    
    // ==================== UPDATE LOCATION FUNCTION ====================
    async function updateLocationFromMarker(position) {
      const [lat, lng] = position;
      
      Loading.show();
      try {
        const address = await reverseGeocode(lat, lng);
        
        selectedDeliveryLocation = {
          lat: lat,
          lng: lng,
          address: address
        };
        
        // Update form fields (including hidden lat/lng fields)
        // Combine address with coordinates in the delivery address field
        const fullAddress = `${address}\n[‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(6)}, ${lng.toFixed(6)}]`;
        document.getElementById('deliveryAddress').value = fullAddress;
        document.getElementById('delivery_lat').value = lat;
        document.getElementById('delivery_lng').value = lng;
        
        // Update address preview (simplified display)
        const addressPreview = document.getElementById('addressPreview');
        addressPreview.style.display = 'block';
        document.getElementById('addressPreviewText').textContent = address;
        
        // Update info display
        const locationInfo = document.getElementById('locationInfo');
        locationInfo.className = 'location-info selected';
        locationInfo.innerHTML = `
          <h4>‚úÖ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å / Selected Location</h4>
          <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${address}</p>
        `;
        
        // Update marker popup
        deliveryMarker.bindPopup(`
          <strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</strong><br>
          <small>${address}</small>
        `).openPopup();
        
      } catch (error) {
        console.error('Error getting address:', error);
        Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ');
      } finally {
        Loading.hide();
      }
    }
    
    // ==================== REVERSE GEOCODE FUNCTION ====================
    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
          {
            headers: {
              'Accept-Language': 'th,en'
            }
          }
        );
        
        if (!response.ok) {
          throw new Error('Geocoding failed');
        }
        
        const data = await response.json();
        
        // Format Thai address
        const addr = data.address || {};
        let addressParts = [];
        
        if (addr.house_number) addressParts.push(addr.house_number);
        if (addr.road) addressParts.push(addr.road);
        if (addr.suburb) addressParts.push(addr.suburb);
        if (addr.city || addr.town || addr.village) {
          addressParts.push(addr.city || addr.town || addr.village);
        }
        if (addr.state) addressParts.push(addr.state);
        if (addr.postcode) addressParts.push(addr.postcode);
        
        return addressParts.length > 0 
          ? addressParts.join(', ')
          : data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          
      } catch (error) {
        console.error('Reverse geocode error:', error);
        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
    }
    
    // ==================== GPS LOCATION FUNCTION ====================
    async function useGPSLocation() {
      if (!navigator.geolocation) {
        Toast.error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
        return;
      }
      
      Loading.show();
      Toast.show('‡∏Å‡πâ‡∏≠‡∏ô‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...', 'info', 2000);
      
      navigator.geolocation.getCurrentPosition(
        async function(position) {
          const userLocation = [position.coords.latitude, position.coords.longitude];
          
          // Move map and marker
          deliveryMap.setView(userLocation, 16);
          deliveryMarker.setLatLng(userLocation);
          
          // Add accuracy circle
          L.circle(userLocation, {
            radius: position.coords.accuracy,
            color: '#4285F4',
            fillColor: '#4285F4',
            fillOpacity: 0.1
          }).addTo(deliveryMap);
          
          await updateLocationFromMarker(userLocation);
          Loading.hide();
          Toast.success('üéØ ‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!');
        },
        function(error) {
          Loading.hide();
          let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
              break;
            case error.TIMEOUT:
              errorMessage = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
              break;
          }
          
          Toast.error(errorMessage);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
    
    // Try to auto-detect GPS on page load (silently)
    function tryAutoGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async function(position) {
            const userLocation = [position.coords.latitude, position.coords.longitude];
            deliveryMap.setView(userLocation, 15);
            deliveryMarker.setLatLng(userLocation);
            await updateLocationFromMarker(userLocation);
            Toast.success('üéØ ‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!');
          },
          function(error) {
            // Silently fail, user can manually select
            console.log('Auto GPS detection skipped:', error.message);
          },
          {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 60000
          }
        );
      }
    }
    
    // ==================== ADDRESS SEARCH ====================
    function toggleAddressSearch() {
      const searchBox = document.getElementById('searchBox');
      searchBox.classList.toggle('show');
      if (searchBox.classList.contains('show')) {
        document.getElementById('addressSearchInput').focus();
      }
    }
    
    async function searchAddress() {
      const query = document.getElementById('addressSearchInput').value.trim();
      
      if (!query) {
        Toast.warning('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
        return;
      }
      
      Loading.show();
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=th&limit=5`,
          {
            headers: {
              'Accept-Language': 'th,en'
            }
          }
        );
        
        if (!response.ok) {
          throw new Error('Search failed');
        }
        
        const results = await response.json();
        
        if (results.length === 0) {
          Loading.hide();
          Toast.warning('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà');
          return;
        }
        
        // Use first result
        const location = results[0];
        const position = [parseFloat(location.lat), parseFloat(location.lon)];
        
        // Move map and marker
        deliveryMap.setView(position, 16);
        deliveryMarker.setLatLng(position);
        
        await updateLocationFromMarker(position);
        Loading.hide();
        Toast.success(`‡∏û‡∏ö ${results.length} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå`);
        
      } catch (error) {
        Loading.hide();
        console.error('Search error:', error);
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
      }
    }
    
    // ==================== EXPORT FUNCTIONS FOR EXTERNAL USE ====================
    window.getDeliveryLocation = function() {
      return selectedDeliveryLocation;
    };
    
    window.setDeliveryLocation = function(lat, lng) {
      if (deliveryMap && deliveryMarker) {
        const position = [lat, lng];
        deliveryMap.setView(position, 16);
        deliveryMarker.setLatLng(position);
        updateLocationFromMarker(position);
      }
    };
    
    window.getMapCoordinates = function() {
      if (selectedDeliveryLocation) {
        return {
          lat: selectedDeliveryLocation.lat,
          lng: selectedDeliveryLocation.lng,
          address: selectedDeliveryLocation.address
        };
      }
      return null;
    };
    
    // ==================== ORDERS FUNCTIONS ====================
    let allOrders = [];
    
    async function loadOrders() {
      Loading.show();
      
      try {
        const result = await API.getOrders({ customer_id: currentUser.id });
        
        Loading.hide();
        
        if (result.success) {
          allOrders = result.orders;
          renderOrders(allOrders);
          updateStats(allOrders);
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ / Cannot load orders');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / An error occurred');
        console.error('Load orders error:', error);
      }
    }
    
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      
      if (orders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <div class="empty-state-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / No orders yet</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td><strong>${order.order_id.substring(0, 8)}</strong></td>
          <td>${order.bale_type}</td>
          <td>${order.quantity} ‡∏Å‡πâ‡∏≠‡∏ô</td>
          <td>${formatDateShort(order.pickup_date)}</td>
          <td>${getStatusBadge(order.status)}</td>
          <td>${order.farmer_name}</td>
          <td>${order.baler_name}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-view btn-sm" onclick="viewOrderDetails('${order.order_id}')">
                ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </button>
              ${order.status === 'pending' ? `
                <button class="btn-cancel btn-sm" onclick="cancelOrder('${order.order_id}')">
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    function updateStats(orders) {
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('pendingOrders').textContent = 
        orders.filter(o => o.status === 'pending').length;
      document.getElementById('deliveredOrders').textContent = 
        orders.filter(o => o.status === 'delivered').length;
    }
    
    async function viewOrderDetails(orderId) {
      Loading.show();
      
      try {
        const result = await API.getOrderById(orderId);
        
        Loading.hide();
        
        if (result.success) {
          const order = result.order;
          
          let content = `
            <div style="margin-bottom: var(--space-md);">
              <h3 style="color: var(--field-green);">Order #${order.order_id.substring(0, 8)}</h3>
              <p>${getStatusBadge(order.status)}</p>
            </div>
            
            <div style="margin-bottom: var(--space-lg);">
              <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / Order Information</h4>
              <table style="width: 100%;">
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á:</strong></td>
                  <td>${order.bale_type}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong></td>
                  <td>${order.quantity} ‡∏Å‡πâ‡∏≠‡∏ô</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö:</strong></td>
                  <td>${formatDate(order.pickup_date)}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong></td>
                  <td>${order.delivery_address}</td>
                </tr>
                ${order.delivery_lat && order.delivery_lng ? `
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong></td>
                  <td><code>${parseFloat(order.delivery_lat).toFixed(6)}, ${parseFloat(order.delivery_lng).toFixed(6)}</code></td>
                </tr>
                ` : ''}
                ${order.notes ? `
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong></td>
                  <td>${order.notes}</td>
                </tr>
                ` : ''}
              </table>
            </div>
          `;
          
          // Add map if coordinates exist
          if (order.delivery_lat && order.delivery_lng) {
            content += `
              <div style="margin-bottom: var(--space-lg);">
                <h4>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á / Delivery Location</h4>
                <div id="orderLocationMap" style="height: 300px; border-radius: 8px; border: 2px solid #e0e0e0;"></div>
              </div>
            `;
          }
          
          content += `
            <div style="margin-bottom: var(--space-lg);">
              <h4>‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / Service Providers</h4>
              <div style="background: #F9F9F9; padding: var(--space-md); border-radius: 8px; margin-bottom: var(--space-sm);">
                <strong>‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ / Farmer:</strong> ${order.farmer_name}<br>
                ${order.farmer_phone !== '-' ? `<strong>‡πÇ‡∏ó‡∏£:</strong> ${formatPhone(order.farmer_phone)}` : ''}
              </div>
              <div style="background: #F9F9F9; padding: var(--space-md); border-radius: 8px;">
                <strong>‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á / Baler:</strong> ${order.baler_name}<br>
                ${order.baler_phone !== '-' ? `<strong>‡πÇ‡∏ó‡∏£:</strong> ${formatPhone(order.baler_phone)}` : ''}
              </div>
            </div>
            
            <div>
              <h4>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ / Progress Timeline</h4>
              <div class="timeline">
                ${getTimeline(order.status)}
              </div>
            </div>
          `;
          
          document.getElementById('orderDetailsContent').innerHTML = content;
          Modal.open('orderDetailsModal');
          
          // Initialize map after modal is opened
          if (order.delivery_lat && order.delivery_lng) {
            setTimeout(() => {
              showOrderLocation(
                parseFloat(order.delivery_lat),
                parseFloat(order.delivery_lng),
                order.delivery_address,
                'orderLocationMap'
              );
            }, 100);
          }
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        console.error('View order error:', error);
      }
    }
    
    function showOrderLocation(lat, lng, address, elementId) {
      const map = L.map(elementId).setView([lat, lng], 15);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);
      
      L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map)
        .bindPopup(`<strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</strong><br><small>${address}</small>`)
        .openPopup();
      
      return map;
    }
    
    function getTimeline(currentStatus) {
      const statuses = [
        { key: 'pending', label: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', icon: 'üìù' },
        { key: 'farmer_accepted', label: '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', icon: '‚úÖ' },
        { key: 'baler_assigned', label: '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á', icon: 'üöú' },
        { key: 'in_progress', label: '‡∏Å‡πâ‡∏≠‡∏ô‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', icon: '‚öôÔ∏è' },
        { key: 'delivered', label: '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', icon: '‚úì' }
      ];
      
      const currentIndex = statuses.findIndex(s => s.key === currentStatus);
      
      return statuses.map((status, index) => {
        const isCompleted = index < currentIndex;
        const isActive = index === currentIndex;
        const markerClass = isCompleted ? 'completed' : isActive ? 'active' : '';
        
        return `
          <div class="timeline-item">
            <div class="timeline-marker ${markerClass}">
              ${status.icon}
            </div>
            <div class="timeline-content">
              <div class="timeline-title">${status.label}</div>
              <div class="timeline-description">
                ${isCompleted ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : isActive ? '‡∏Å‡πâ‡∏≠‡∏ô‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function cancelOrder(orderId) {
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ? / Are you sure you want to cancel this order?')) {
        return;
      }
      
      Loading.show();
      
      try {
        const result = await API.cancelOrder(orderId);
        
        Loading.hide();
        
        if (result.success) {
          Toast.success('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / Order cancelled successfully');
          loadOrders();
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        console.error('Cancel order error:', error);
      }
    }
    
    // ==================== FORM SUBMISSION ====================
    document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const orderData = Object.fromEntries(formData.entries());
      orderData.customer_id = currentUser.id;
      
      // Validate that location is selected
      if (!orderData.delivery_lat || !orderData.delivery_lng) {
        Toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà / Please select delivery location on map');
        document.getElementById('deliveryMap').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      
      // Convert coordinates to numbers
      orderData.delivery_lat = parseFloat(orderData.delivery_lat);
      orderData.delivery_lng = parseFloat(orderData.delivery_lng);
      
      // Validate pickup date is not in the past
      const pickupDate = new Date(orderData.pickup_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (pickupDate < today) {
        Toast.error('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï / Pickup date cannot be in the past');
        return;
      }
      
      Loading.show();
      
      try {
        const result = await API.createOrder(orderData);
        
        Loading.hide();
        
        if (result.success) {
          Toast.success('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! / Order created successfully! üéâ');
          
          // Reset form
          e.target.reset();
          document.getElementById('delivery_lat').value = '';
          document.getElementById('delivery_lng').value = '';
          
          // Reset map to default
          const defaultCenter = [18.7883, 98.9853];
          deliveryMap.setView(defaultCenter, 13);
          deliveryMarker.setLatLng(defaultCenter);
          deliveryMarker.bindPopup('üñêÔ∏è ‡∏•‡∏≤‡∏Å‡∏â‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á!<br>Drag me to your delivery location!');
          
          // Reset displays
          document.getElementById('addressPreview').style.display = 'none';
          document.getElementById('locationInfo').className = 'location-info';
          document.getElementById('locationInfo').innerHTML = `
            <h4>üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô / How to use:</h4>
            <p>‚Ä¢ <strong>‡∏•‡∏≤‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ / <strong>Drag the red marker</strong> to your location</p>
            <p>‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î <strong>"üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ GPS / Or tap <strong>"Use GPS"</strong></p>
            <p>‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠<strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</strong> / Or <strong>search address</strong></p>
          `;
          
          selectedDeliveryLocation = null;
          
          loadOrders();
        } else {
          Toast.error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / An error occurred');
        console.error('Create order error:', error);
      }
    });
    
    // ==================== INITIALIZATION ====================
    // Set minimum date for pickup date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('pickupDate').setAttribute('min', today);
    
    // Initialize map
    setTimeout(() => {
      initDeliveryMap();
    }, 100);
    
    // Load orders
    loadOrders();
  </script>
</body>
</html>
