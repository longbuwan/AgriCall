<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - BaleConnect</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="dashboard.css">
  
  <!-- Leaflet CSS for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="dashboard">
  <!-- Header -->
  <header class="dashboard-header">
    <nav class="dashboard-nav">
      <a href="#" class="dashboard-logo">
        <span class="logo-icon">üåæ</span>
        <span>BaleConnect</span>
      </a>
      
      <div class="dashboard-user">
        <div class="user-info">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-type">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Customer</div>
        </div>
        
        <button class="notification-bell" onclick="alert('Notifications feature coming soon!')">
          üîî
          <span class="notification-badge hidden" id="notifBadge">0</span>
        </button>
        
        <button class="logout-btn" onclick="Auth.logout()">
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö / Logout
        </button>
      </div>
    </nav>
  </header>
  
  <!-- Main Content -->
  <main class="dashboard-content">
    <div class="container">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card green">
          <div class="stat-label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / Total Orders</div>
          <div class="stat-value" id="totalOrders">0</div>
        </div>
        
        <div class="stat-card orange">
          <div class="stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ / Pending</div>
          <div class="stat-value" id="pendingOrders">0</div>
        </div>
        
        <div class="stat-card blue">
          <div class="stat-label">‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß / Delivered</div>
          <div class="stat-value" id="deliveredOrders">0</div>
        </div>
      </div>
      
      <!-- Create New Order Section -->
      <div class="card">
        <div class="section-header">
          <h2 class="section-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà / Create New Order</h2>
        </div>
        
        <form id="createOrderForm">
          <div class="d-flex gap-2" style="flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="baleType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á / Bale Type</label>
              <select id="baleType" name="bale_type" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á / Select Type</option>
                <option value="‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß (Rice Straw)">‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß / Rice Straw</option>
                <option value="‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î (Corn Straw)">‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î / Corn Straw</option>
                <option value="‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏•‡∏µ (Wheat Straw)">‡∏ü‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏•‡∏µ / Wheat Straw</option>
                <option value="‡∏ü‡∏≤‡∏á‡∏≠‡πâ‡∏≠‡∏¢ (Sugarcane Straw)">‡∏ü‡∏≤‡∏á‡∏≠‡πâ‡∏≠‡∏¢ / Sugarcane Straw</option>
              </select>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô / Quantity</label>
              <input type="number" id="quantity" name="quantity" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≥ / Number of bales" min="1" required>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="pickupDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö / Pickup Date</label>
              <input type="date" id="pickupDate" name="pickup_date" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="deliveryAddress">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á / Delivery Address</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
              <textarea id="deliveryAddress" name="delivery_address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏≤‡∏á" required style="flex: 1;"></textarea>
              <button type="button" class="btn btn-secondary" onclick="openLocationPickerModal()" style="white-space: nowrap; height: fit-content;">
                üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
              </button>
            </div>
            <small style="color: #666; display: block; margin-top: 0.25rem;">
              üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ GPS ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
            </small>
            <!-- Hidden fields for coordinates -->
            <input type="hidden" id="delivery_lat" name="delivery_lat">
            <input type="hidden" id="delivery_lng" name="delivery_lng">
          </div>
          
          <div class="form-group">
            <label for="notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / Notes (Optional)</label>
            <textarea id="notes" name="notes" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å, ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©"></textarea>
          </div>
          
          <button type="submit" class="btn btn-primary">
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / Create Order
          </button>
        </form>
      </div>
      
      <!-- My Orders Section -->
      <div class="card">
        <div class="section-header">
          <h2 class="section-title">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / My Orders</h2>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á / Type</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô / Qty</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö / Date</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / Status</th>
                <th>‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ / Farmer</th>
                <th>‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á / Baler</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <tr>
                <td colspan="8" class="empty-state">
                  <div class="empty-state-icon">üì¶</div>
                  <div class="empty-state-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / No orders yet</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / Order Details</h2>
        <button type="button" class="close-modal" onclick="Modal.close('orderDetailsModal')">&times;</button>
      </div>
      
      <div id="orderDetailsContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Leaflet JS for maps -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script src="utils.js"></script>
  <script src="api.js"></script>
  <script src="map-utils.js"></script>
  
  <script>
    // Check authentication
    const currentUser = Auth.requireAuth(['customer']);
    if (!currentUser) {
      // Will redirect to login
      throw new Error('Not authenticated');
    }
    
    // Set user name
    document.getElementById('userName').textContent = currentUser.name;
    
    // Load orders
    let allOrders = [];
    
    async function loadOrders() {
      Loading.show();
      
      try {
        const result = await API.getOrders({ customer_id: currentUser.id });
        
        Loading.hide();
        
        if (result.success) {
          allOrders = result.orders;
          renderOrders(allOrders);
          updateStats(allOrders);
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ / Cannot load orders');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / An error occurred');
        console.error('Load orders error:', error);
      }
    }
    
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      
      if (orders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <div class="empty-state-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / No orders yet</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td><strong>${order.order_id.substring(0, 8)}</strong></td>
          <td>${order.bale_type}</td>
          <td>${order.quantity} ‡∏Å‡∏≥</td>
          <td>${formatDateShort(order.pickup_date)}</td>
          <td>${getStatusBadge(order.status)}</td>
          <td>${order.farmer_name}</td>
          <td>${order.baler_name}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-view btn-sm" onclick="viewOrderDetails('${order.order_id}')">
                ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </button>
              ${order.status === 'pending' ? `
                <button class="btn-cancel btn-sm" onclick="cancelOrder('${order.order_id}')">
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    function updateStats(orders) {
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('pendingOrders').textContent = 
        orders.filter(o => o.status === 'pending').length;
      document.getElementById('deliveredOrders').textContent = 
        orders.filter(o => o.status === 'delivered').length;
    }
    
    async function viewOrderDetails(orderId) {
      Loading.show();
      
      try {
        const result = await API.getOrderById(orderId);
        
        Loading.hide();
        
        if (result.success) {
          const order = result.order;
          
          let content = `
            <div style="margin-bottom: var(--space-md);">
              <h3 style="color: var(--field-green);">Order #${order.order_id.substring(0, 8)}</h3>
              <p>${getStatusBadge(order.status)}</p>
            </div>
            
            <div style="margin-bottom: var(--space-lg);">
              <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / Order Information</h4>
              <table style="width: 100%;">
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≤‡∏á:</strong></td>
                  <td>${order.bale_type}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong></td>
                  <td>${order.quantity} ‡∏Å‡∏≥</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö:</strong></td>
                  <td>${formatDate(order.pickup_date)}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong></td>
                  <td>${order.delivery_address}</td>
                </tr>
                ${order.notes ? `
                <tr>
                  <td style="padding: 0.5rem 0;"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong></td>
                  <td>${order.notes}</td>
                </tr>
                ` : ''}
              </table>
            </div>
          `;
          
          // Add map if coordinates exist
          if (order.delivery_lat && order.delivery_lng) {
            content += `
              <div style="margin-bottom: var(--space-lg);">
                <h4>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á / Delivery Location</h4>
                <div id="orderLocationMap" style="height: 300px; border-radius: 8px; border: 2px solid #e0e0e0;"></div>
              </div>
            `;
          }
          
          content += `
            <div style="margin-bottom: var(--space-lg);">
              <h4>‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / Service Providers</h4>
              <div style="background: #F9F9F9; padding: var(--space-md); border-radius: 8px; margin-bottom: var(--space-sm);">
                <strong>‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ / Farmer:</strong> ${order.farmer_name}<br>
                ${order.farmer_phone !== '-' ? `<strong>‡πÇ‡∏ó‡∏£:</strong> ${formatPhone(order.farmer_phone)}` : ''}
              </div>
              <div style="background: #F9F9F9; padding: var(--space-md); border-radius: 8px;">
                <strong>‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á / Baler:</strong> ${order.baler_name}<br>
                ${order.baler_phone !== '-' ? `<strong>‡πÇ‡∏ó‡∏£:</strong> ${formatPhone(order.baler_phone)}` : ''}
              </div>
            </div>
            
            <div>
              <h4>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ / Progress Timeline</h4>
              <div class="timeline">
                ${getTimeline(order.status)}
              </div>
            </div>
          `;
          
          document.getElementById('orderDetailsContent').innerHTML = content;
          Modal.open('orderDetailsModal');
          
          // Initialize map after modal is opened and DOM is ready
          if (order.delivery_lat && order.delivery_lng) {
            setTimeout(() => {
              showOrderLocation(
                parseFloat(order.delivery_lat),
                parseFloat(order.delivery_lng),
                order.delivery_address,
                'orderLocationMap'
              );
            }, 100);
          }
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        console.error('View order error:', error);
      }
    }
    
    function getTimeline(currentStatus) {
      const statuses = [
        { key: 'pending', label: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', icon: 'üìù' },
        { key: 'farmer_accepted', label: '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', icon: '‚úÖ' },
        { key: 'baler_assigned', label: '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏≠‡∏±‡∏î‡∏ü‡∏≤‡∏á', icon: 'üöú' },
        { key: 'in_progress', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', icon: '‚öôÔ∏è' },
        { key: 'delivered', label: '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', icon: '‚úì' }
      ];
      
      const currentIndex = statuses.findIndex(s => s.key === currentStatus);
      
      return statuses.map((status, index) => {
        const isCompleted = index < currentIndex;
        const isActive = index === currentIndex;
        const markerClass = isCompleted ? 'completed' : isActive ? 'active' : '';
        
        return `
          <div class="timeline-item">
            <div class="timeline-marker ${markerClass}">
              ${status.icon}
            </div>
            <div class="timeline-content">
              <div class="timeline-title">${status.label}</div>
              <div class="timeline-description">
                ${isCompleted ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : isActive ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function cancelOrder(orderId) {
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ? / Are you sure you want to cancel this order?')) {
        return;
      }
      
      Loading.show();
      
      try {
        const result = await API.cancelOrder(orderId);
        
        Loading.hide();
        
        if (result.success) {
          Toast.success('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / Order cancelled successfully');
          loadOrders();
        } else {
          Toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        console.error('Cancel order error:', error);
      }
    }
    
    // Create order form handler
    document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const formData = new FormData(e.target);
      const orderData = Object.fromEntries(formData.entries());
      orderData.customer_id = currentUser.id;
      
      // Validate that location is selected
      if (!orderData.delivery_lat || !orderData.delivery_lng) {
        Toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà / Please select delivery location on map');
        return;
      }
      
      // Convert coordinates to numbers
      orderData.delivery_lat = parseFloat(orderData.delivery_lat);
      orderData.delivery_lng = parseFloat(orderData.delivery_lng);
      
      // Validate pickup date is not in the past
      const pickupDate = new Date(orderData.pickup_date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (pickupDate < today) {
        Toast.error('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï / Pickup date cannot be in the past');
        return;
      }
      
      Loading.show();
      
      try {
        const result = await API.createOrder(orderData);
        
        Loading.hide();
        
        if (result.success) {
          Toast.success('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à / Order created successfully');
          
          // Reset form
          e.target.reset();
          document.getElementById('delivery_lat').value = '';
          document.getElementById('delivery_lng').value = '';
          
          // Reset map to default location
          const defaultCenter = [18.7883, 98.9853];
          deliveryMap.setView(defaultCenter, 13);
          deliveryMarker.setLatLng(defaultCenter);
          
          // Reset location info
          document.getElementById('locationInfo').className = 'location-info';
          document.getElementById('locationInfo').innerHTML = `
            <h4>üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô / How to use:</h4>
            <p>‚Ä¢ <strong>‡∏•‡∏≤‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</strong> ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / <strong>Drag the marker</strong> to select location</p>
            <p>‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î <strong>"üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ GPS / Or tap <strong>"Use GPS"</strong> button</p>
            <p>‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠<strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</strong>‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á / Or <strong>search for address</strong> below</p>
          `;
          
          selectedDeliveryLocation = null;
          
          loadOrders();
        } else {
          Toast.error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        Loading.hide();
        Toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / An error occurred');
        console.error('Create order error:', error);
      }
    });
    
    // Set minimum date for pickup date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('pickupDate').setAttribute('min', today);
    
    // Initialize map when page loads
    setTimeout(() => {
      initDeliveryMap();
    }, 100);
    
    // Export location data for use in other operations
    window.getDeliveryLocation = function() {
      return selectedDeliveryLocation;
    };
    
    window.setDeliveryLocation = function(lat, lng) {
      if (deliveryMap && deliveryMarker) {
        const position = [lat, lng];
        deliveryMap.setView(position, 16);
        deliveryMarker.setLatLng(position);
        updateLocationFromMarker(position);
      }
    };
    
    window.getMapCoordinates = function() {
      if (selectedDeliveryLocation) {
        return {
          lat: selectedDeliveryLocation.lat,
          lng: selectedDeliveryLocation.lng,
          address: selectedDeliveryLocation.address
        };
      }
      return null;
    };
    
    // Initial load
    loadOrders();
  </script>
</body>
</html>
